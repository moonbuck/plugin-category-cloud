{{ define "main" -}}
  
  {{/* Make sure the plugin parameters have been loaded. */}}
  {{- if not (.Scratch.Get "plugin-category-cloud.Parameters") -}}
    {{- partial "plugin-category-cloud/load-parameters.html" . -}}
  {{- end -}}

  {{/* Fetch the loaded parameter values. */}}
  {{- $Parameters := .Scratch.Get "plugin-category-cloud.Parameters" -}}
  
  {{/* Calculate the step assignments */}}
  {{- $Steps := partial "plugin-category-cloud/calculate-steps.html" . -}}

{{/* Open up the wrapper. */}}
<div id="{{ $Parameters.Style.WrapperID }}">
    
  {{/* Iterate over the non-excluded categories. */}}
  {{- range $name, 
            $taxonomy := (where site.Taxonomies.categories
                         "Name" "not in" $Parameters.Config.ExclusionList) }}

    {{/* Fetch the assigned step. */}}
    {{- $step := index $Steps ($taxonomy.Count | string) -}}    
    
    {{/* Generate the link's target. */}}
    {{- $href := path.Join ("/categories/" | relLangURL) $name }}
    
    {{/* Overwrite with menu matched URL if present. */}}
    {{- with (index $Parameters.MenuURLs $name) }}{{ $href = . }}{{ end -}}

    {{/* Overwrite the anchorized name with its provided display name. */}}
    {{- with (index $Parameters.Config.DisplayNames $name) }}
      {{- $name = . -}}

    {{/* Otherwise, humanize the anchorized name when flagged. */}}
    {{- else -}}
      {{- if $Parameters.Config.Humanize -}}            
        {{- $name = delimit (apply (split $name "-") "humanize" ".") " " -}}           
      {{- end -}} 
    {{- end -}}

  {{/* Create the link for this category. */}}
  <a href="{{ $href | safeURL }}" class="step-{{ $step }}">
    {{- if $Parameters.Config.UnbreakableLinks }}<nobr>{{ end -}}
    {{- $name }}<span> ({{ $taxonomy.Count }})</span>
    {{- if $Parameters.Config.UnbreakableLinks }}</nobr>{{ end -}}
  </a> 
  
  {{- end -}} {{/* range $anchorized_nameâ€¦ */}}

{{/* Close the wrapper. */}}
</div>
    
{{- end -}} {{/* define "main" */}}